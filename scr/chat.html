<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=0.8" />
<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-database.js"></script>
<style type="text/css">

/*-------------------- Body --------------------*/
* {box-sizing: border-box}
html, body {height: 100%}
body {
  background: Silver;
  background-size: cover;
  font: 14px monospace;
  line-height: 1.3;
  overflow: hidden;
}

/*-------------------- Chat --------------------*/
.chat {
  position: absolute;
  top: 50%; left: 50%;
  -webkit-transform: translate(-50%, -50%);
          transform: translate(-50%, -50%);
  width: 440px; height: 85vh; max-height: 100vh;
  overflow: auto;
  box-shadow: 0 5px 30px rgba(0, 0, 0, 0.2);
  background: rgba(0, 0, 0, 0.5);
  border-radius: 20px;
  display: -webkit-box;
  display: -webkit-flex;
  display: -ms-flexbox;
  display: flex;
  -webkit-flex-direction: column;
      -ms-flex-direction: column;
          flex-direction: column;
}

/*-------------------- Chat Title --------------------*/
.chat-title {
  position: relative;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  text-align: left;
  padding: 10px 10px 10px 15px;
}
.chat-title h1, .chat-title h2 {
  font-weight: normal;
  font-size: 14px;
  margin: 0; padding: 0;
}
.chat-title h2 {
  color: rgba(255, 255, 255, 0.5);
  font-size: 12px;
  letter-spacing: 1px;
}

/*-------------------- Messages --------------------*/
.messages {
  -webkit-box-flex: 1;
  -webkit-flex: 1 1 auto; -ms-flex: 1 1 auto; flex: 1 1 auto;
  color: Chartreuse;
  overflow: auto;
  position: relative;
  width: 100%;
}
.messages .messages-content {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 101%;
  padding-top: 8px
}
.messages .message {
  min-width: 50%;
  max-width: 95%;
  float: left;
  padding: 6px 10px 7px;
  border-radius: 0 10px 10px 10px;
  background: rgba(0, 0, 0, 0.4);
  margin: 8px 0 15px 5px;
  font-size: 14px;
  line-height: 1.4;
  position: relative;
  overflow-wrap: break-word;
  text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
}
.messages .message .timestamp {
  position: absolute; bottom: -15px;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.7);
}
.messages .message.message-personal {
  float: right;
  color: #fff;
  text-align: right;
  margin-right: 5px;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 10px 10px 0 10px;
}

/*-------------------- Message Box --------------------*/
.message-box {
  -webkit-box-flex: 0;
  -webkit-flex: 0 1 40px; -ms-flex: 0 1 40px; flex: 0 1 40px;
  width: 100%;
  background: rgba(0, 0, 0, 0.8);
  padding: 10px;
  position: relative;
}
.message-box .message-input {
  background: none;
  border: none;
  outline: none !important;
  resize: none;
  color: rgba(255, 255, 255, 0.8);
  font-size: 14px;
  width: 80%; height: 50px;
  margin: 0;
  overflow: hidden;
}
.message-box .message-submit {
  position: absolute; top: 9px; right: 10px;
  color: #fff;
  border: none;
  background: #248A52;
  font-size: 10px;
  text-transform: uppercase;
  line-height: 1;
  padding: 8px 15px;
  border-radius: 10px;
  outline: none !important;
}
.message-box .message-submit:hover {
  background: #1D7745;
}

/*-------------------- Custom Srollbar --------------------*/
.messages::-webkit-scrollbar {
  background-color: rgba(0, 0, 0, 0.2);
  width: 15px;
}
.messages::-webkit-scrollbar-thumb  {
  width: 7px;
  background-color: rgba(0, 0, 0, 0.8);
}
</style>
<script>
function QS(a) {return document.querySelector(a)}
var firebaseConfig = {
	apiKey: "AIzaSyC7fYxUNGewjRcBiB8CE6DFG1sPRbYqHhA",
	authDomain: "jade-b04a6.firebaseapp.com",
	databaseURL: "https://jade-b04a6-default-rtdb.europe-west1.firebasedatabase.app",
	projectId: "jade-b04a6",
	storageBucket: "jade-b04a6.appspot.com",
	messagingSenderId: "843465519719",
	appId: "1:843465519719:web:21efb8ea25b08bbcc69ac2",
	measurementId: "G-6KE10FMESB"
};
firebase.initializeApp(firebaseConfig);

firebase.database().ref("messages").on("child_removed", function (snapshot) {
	document.getElementById("message-" + snapshot.key).innerHTML ="<span style='color:OrangeRed'>Сообщение удалено</span>";
});

function deleteMessage(self) {
	var messageId = self.getAttribute("data-id");
	firebase.database().ref("messages").child(messageId).remove();
	QS('.message-input').focus();
}

function sendMessage() {
	var message = document.getElementById("message").value;
	firebase.database().ref("messages").push().set({
		"time": td_dati(new Date()),
		"message": t(message,1,''),
		"sender": myName
	}); return false;
}
function t(a,b,r) {
	for (var s of a.split('')){
		r += String.fromCharCode(s.charCodeAt(0)+b*(!(s.charCodeAt(0) % 2)?544:588))
	} return r;
}
</script>

<style>
	.btn-delete {background:red; color:white; border:none; margin:3px 0 0 10px; border-radius:5px}
</style>
</head>
<div class="chat">
  <div class="chat-title">
    <h1>JP</h1>
    <h2>Chat Room</h2>
  </div>
  <div class="messages">
    <div class="messages-content"></div>
  </div>
  <div class="message-box">
    <textarea type="text" class="message-input" id="message" placeholder="Новое сообщение ..."></textarea>
    <button type="submit" class="message-submit">Send</button>
  </div>
</div>
<script>
var d, h, m, i = 0, myName ='';
function td_dati(a) {a = new Date(a.getTime()+10800000).toISOString();
	return a.slice(0,10).replace(/(\d+)-(\d+)-(\d+)/, '$3-$2-$1') +'_'+ a.slice(11,16)
}
function stop(e) {
	if (e.preventDefault) {e.preventDefault(); e.stopPropagation()} // стандарт
	else {e.returnValue = false; e.cancelBubble = true} // IE8-
}
myName = location.href.split('?')[1]; //prompt("Enter your name");

firebase.database().ref("messages").on("child_added", function (snapshot) {
	res = JSON.parse(JSON.stringify(snapshot)); res.message = t(res.message,-1,'');
    if (res.sender == myName) {
	QS('.messages-content').insertAdjacentHTML("beforeend",'<div class="message message-personal"><div id="message-'+ snapshot.key +'">'+
		res.message +'<button class="btn-delete" data-id="'+ snapshot.key +'" onclick="deleteMessage(this);" title="Удалить сообщение">X</button></div><div class="timestamp">'+ res.time +'</div></div>');
	QS('.message-input').value ='';
    } else {
	QS('.messages-content').insertAdjacentHTML("beforeend",'<div class="message"><div id="message-'+ snapshot.key +'">'+ res.sender +' > '+ res.message +'</div><div class="timestamp">'+ res.time +'</div></div>');
    }
    try {QS('.messages').scrollTop = QS('.messages').scrollHeight} catch(e) {}
});

function insertMessage() {
	msg = QS('.message-input').value;
	if (msg == '') {return false} sendMessage();
}

QS('.message-submit').onclick = function() {insertMessage()}
QS('.message-input').focus();
document.addEventListener('keydown', function(event) { if (!window.event.ctrlKey && event.keyCode == 13) {insertMessage(); stop(event)} });
</script>
</html>
